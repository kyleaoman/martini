

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>martini._martini &mdash; MARTINI 1.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> MARTINI
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../includeme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../martini.html">Martini (martini.Martini)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datacube.html">Data Cube (martini.DataCube)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source.html">Sources (martini.sources)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beam.html">Beam Models (martini.beams)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../noise.html">Noise Models (martini.noise)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spectral_model.html">Spectral Models (martini.spectral_models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sph_kernel.html">SPH Kernels (martini.sph_kernels)</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MARTINI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>martini._martini</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for martini._martini</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">fftconvolve</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">U</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">astropy_version</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">._version</span> <span class="k">import</span> <span class="n">__version__</span>


<div class="viewcode-block" id="Martini"><a class="viewcode-back" href="../../martini.html#martini._martini.Martini">[docs]</a><span class="k">class</span> <span class="nc">Martini</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used for the creation of synthetic HI data cubes from simulation data.</span>

<span class="sd">    Usual use of martini involves first creating instances of classes from each</span>
<span class="sd">    of the required and optional sub-modules, then creating a Martini with</span>
<span class="sd">    these instances as arguments. The object can then be used to create</span>
<span class="sd">    synthetic observations, usually by calling &#39;insert_source_in_cube&#39;,</span>
<span class="sd">    (optionally) &#39;add_noise&#39;, (optionally) &#39;convolve_beam&#39; and &#39;write_fits&#39; in</span>
<span class="sd">    order.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : an instance of a class derived from martini.source._BaseSource</span>
<span class="sd">        A description of the HI emitting object, including position, geometry</span>
<span class="sd">        and an interface to the simulation data (SPH particle masses,</span>
<span class="sd">        positions, etc.). Sources leveraging the simobj package for reading</span>
<span class="sd">        simulation data (github.com/kyleaoman/simobj) and a few test sources</span>
<span class="sd">        (e.g. single particle) are provided, creation of customized sources,</span>
<span class="sd">        for instance to leverage other interfaces to simulation data, is</span>
<span class="sd">        straightforward. See sub-module documentation.</span>

<span class="sd">    datacube : martini.DataCube instance</span>
<span class="sd">        A description of the datacube to create, including pixels, channels,</span>
<span class="sd">        sky position. See sub-module documentation.</span>

<span class="sd">    beam : (optional) an instance of a class derived from beams._BaseBeam</span>
<span class="sd">        A description of the beam for the simulated telescope. Given a</span>
<span class="sd">        description, either mathematical or as an image, the creation of a</span>
<span class="sd">        custom beam is straightforward. See sub-module documentation.</span>

<span class="sd">    noise : (optional) an instance of a class derived from noise._BaseNoise</span>
<span class="sd">        A description of the simulated noise. A simple Gaussian noise model is</span>
<span class="sd">        provided; implementation of other noise models is straightforward. See</span>
<span class="sd">        sub-module documentation.</span>

<span class="sd">    sph_kernel : an instance of a class derived from sph_kernels._BaseSPHKernel</span>
<span class="sd">        A description of the SPH smoothing kernel. The Wendland C2 kernel (used</span>
<span class="sd">        in EAGLE), and a point-like Dirac-delta kernel are implemented,</span>
<span class="sd">        implementation of other kernels is straightforward. See sub-module</span>
<span class="sd">        documentation.</span>

<span class="sd">    spectral_model : an instance of a class derived from \</span>
<span class="sd">    spectral_models._BaseSpectrum</span>
<span class="sd">        A description of the HI line produced by a particle of given</span>
<span class="sd">        properties. A Dirac-delta spectrum, and both fixed-width and</span>
<span class="sd">        temperature-dependent Gaussian line models are provided; implementing</span>
<span class="sd">        other models is straightforward. See sub-module documentation.</span>

<span class="sd">    logtag : string</span>
<span class="sd">        String to prepend to standard output messages.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : Martini</span>
<span class="sd">        A Martini object configured with the specified sub-modules.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    martini.sources</span>
<span class="sd">    martini.DataCube</span>
<span class="sd">    martini.beams</span>
<span class="sd">    martini.noise</span>
<span class="sd">    martini.sph_kernels</span>
<span class="sd">    martini.spectral_models</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    The following example illustrates basic use of martini, using a (very!)</span>
<span class="sd">    crude model of a gas disk. This example can be run by doing</span>
<span class="sd">    &#39;from martini import demo; demo()&#39;::</span>

<span class="sd">        from martini import Martini, DataCube</span>
<span class="sd">        from martini.beams import GaussianBeam</span>
<span class="sd">        from martini.noise import GaussianNoise</span>
<span class="sd">        from martini.spectral_models import GaussianSpectrum</span>
<span class="sd">        from martini.sph_kernels import DiracDeltaKernel</span>
<span class="sd">        from martini.sources import SPHSource</span>
<span class="sd">        import astropy.units as U</span>
<span class="sd">        import numpy as np</span>

<span class="sd">        # ------make a toy galaxy----------</span>
<span class="sd">        N = 1000</span>
<span class="sd">        phi = np.random.rand(N) * 2 * np.pi</span>
<span class="sd">        r = []</span>
<span class="sd">        for L in np.random.rand(N):</span>
<span class="sd">            def f(r):</span>
<span class="sd">                return L - .5 * (2 - np.exp(-r) * (np.power(r, 2) + 2 * r + 2))</span>
<span class="sd">            r.append(fsolve(f, 1.)[0])</span>
<span class="sd">        r = np.array(r)</span>
<span class="sd">        # exponential disk</span>
<span class="sd">        r *= 3 / np.sort(r)[N // 2]</span>
<span class="sd">        z = -np.log(np.random.rand(N))</span>
<span class="sd">        # exponential scale height</span>
<span class="sd">        z *= .5 / np.sort(z)[N // 2] * np.sign(np.random.rand(N) - .5)</span>
<span class="sd">        x = r * np.cos(phi)</span>
<span class="sd">        y = r * np.sin(phi)</span>
<span class="sd">        xyz_g = np.vstack((x, y, z)) * U.kpc</span>
<span class="sd">        # linear rotation curve</span>
<span class="sd">        vphi = 100 * r / 6.</span>
<span class="sd">        vx = -vphi * np.sin(phi)</span>
<span class="sd">        vy = vphi * np.cos(phi)</span>
<span class="sd">        # small pure random z velocities</span>
<span class="sd">        vz = (np.random.rand(N) * 2. - 1.) * 5</span>
<span class="sd">        vxyz_g = np.vstack((vx, vy, vz)) * U.km * U.s ** -1</span>
<span class="sd">        T_g = np.ones(N) * 8E3 * U.K</span>
<span class="sd">        mHI_g = np.ones(N) / N * 5.E9 * U.Msun</span>
<span class="sd">        # ~mean interparticle spacing smoothing</span>
<span class="sd">        hsm_g = np.ones(N) * 2 / np.sqrt(N) * U.kpc</span>
<span class="sd">        # ---------------------------------</span>

<span class="sd">        source = SPHSource(</span>
<span class="sd">            distance=5. * U.Mpc,</span>
<span class="sd">            rotation={&#39;L_coords&#39;: (60. * U.deg, 0. * U.deg)},</span>
<span class="sd">            ra=0. * U.deg,</span>
<span class="sd">            dec=0. * U.deg,</span>
<span class="sd">            h=.7,</span>
<span class="sd">            T_g=T_g,</span>
<span class="sd">            mHI_g=mHI_g,</span>
<span class="sd">            xyz_g=xyz_g,</span>
<span class="sd">            vxyz_g=vxyz_g,</span>
<span class="sd">            hsm_g=hsm_g</span>
<span class="sd">        )</span>

<span class="sd">        datacube = DataCube(</span>
<span class="sd">            n_px_x=128,</span>
<span class="sd">            n_px_y=128,</span>
<span class="sd">            n_channels=32,</span>
<span class="sd">            px_size=10. * U.arcsec,</span>
<span class="sd">            channel_width=10. * U.km * U.s ** -1,</span>
<span class="sd">            velocity_centre=source.vsys</span>
<span class="sd">        )</span>

<span class="sd">        beam = GaussianBeam(</span>
<span class="sd">            bmaj=30. * U.arcsec,</span>
<span class="sd">            bmin=30. * U.arcsec,</span>
<span class="sd">            bpa=0. * U.deg,</span>
<span class="sd">            truncate = 4.</span>
<span class="sd">        )</span>

<span class="sd">        noise = GaussianNoise(</span>
<span class="sd">            rms=3.E-4 * U.Jy * U.arcsec ** -2</span>
<span class="sd">        )</span>

<span class="sd">        spectral_model = GaussianSpectrum(</span>
<span class="sd">            sigma=7 * U.km * U.s ** -1</span>
<span class="sd">        )</span>

<span class="sd">        sph_kernel = DiracDeltaKernel()</span>

<span class="sd">        M = Martini(</span>
<span class="sd">            source=source,</span>
<span class="sd">            datacube=datacube,</span>
<span class="sd">            beam=beam,</span>
<span class="sd">            noise=noise,</span>
<span class="sd">            spectral_model=spectral_model,</span>
<span class="sd">            sph_kernel=sph_kernel</span>
<span class="sd">        )</span>

<span class="sd">        M.insert_source_in_cube()</span>
<span class="sd">        M.add_noise()</span>
<span class="sd">        M.convolve_beam()</span>
<span class="sd">        M.write_beam_fits(&#39;testbeam.fits&#39;, channels=&#39;velocity&#39;)</span>
<span class="sd">        M.write_fits(&#39;testcube.fits&#39;, channels=&#39;velocity&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">datacube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">beam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sph_kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">spectral_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">logtag</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span> <span class="o">=</span> <span class="n">datacube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="n">beam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sph_kernel</span> <span class="o">=</span> <span class="n">sph_kernel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_model</span> <span class="o">=</span> <span class="n">spectral_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logtag</span> <span class="o">=</span> <span class="n">logtag</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">init_kernel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">add_pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">needs_pad</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_source</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">init_spectra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="p">)</span>

        <span class="k">return</span>

<div class="viewcode-block" id="Martini.convolve_beam"><a class="viewcode-back" href="../../martini.html#martini._martini.Martini.convolve_beam">[docs]</a>    <span class="k">def</span> <span class="nf">convolve_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convolve the beam and DataCube.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">for</span> <span class="n">spatial_slice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">spatial_slices</span><span class="p">():</span>
            <span class="c1"># use a view [...] to force in-place modification</span>
            <span class="n">spatial_slice</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span>
                <span class="n">spatial_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">drop_pad</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
            <span class="n">U</span><span class="o">.</span><span class="n">Jy</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">beam</span><span class="o">**-</span><span class="mi">1</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">arcsec_to_beam</span><span class="p">])</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Martini.add_noise"><a class="viewcode-back" href="../../martini.html#martini._martini.Martini.add_noise">[docs]</a>    <span class="k">def</span> <span class="nf">add_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert noise into the DataCube.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_prune_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines which particles cannot contribute to the DataCube and</span>
<span class="sd">        removes them to speed up calculation. Assumes the kernel is 0 at</span>
<span class="sd">        distances greater than the SPH smoothing length.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pixels indexed from 0 (not like in FITS!) for better use with numpy</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">skycoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sky_coordinates</span>
        <span class="n">particle_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span>
                <span class="n">skycoords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">skycoords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">skycoords</span><span class="o">.</span><span class="n">radial_velocity</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">origin</span><span class="p">))</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span>
        <span class="c1"># could use a function bound to source which returns the size of the</span>
        <span class="c1"># kernel, in case this isn&#39;t equal to the smoothing length for some</span>
        <span class="c1"># kernel</span>
        <span class="n">sm_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">hsm_g</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sky_coordinates</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">px_size</span> <span class="o">/</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">))</span>
        <span class="n">sm_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sm_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">spectrum_half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">half_width</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">/</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">channel_width</span>
        <span class="n">reject_conditions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">particle_coords</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">sm_range</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">&lt;</span>
             <span class="mi">0</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">particle_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sm_range</span> <span class="o">&gt;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">n_px_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">padx</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span>
            <span class="n">particle_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sm_range</span> <span class="o">&gt;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">n_px_y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">pady</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span>
            <span class="n">particle_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">spectrum_half_width</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span>
            <span class="n">particle_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">spectrum_half_width</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span> <span class="o">&gt;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">reject_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">particle_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">reject_conditions</span><span class="p">:</span>
            <span class="n">reject_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">reject_mask</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">apply_mask</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">reject_mask</span><span class="p">))</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Martini.insert_source_in_cube"><a class="viewcode-back" href="../../martini.html#martini._martini.Martini.insert_source_in_cube">[docs]</a>    <span class="k">def</span> <span class="nf">insert_source_in_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates the DataCube with flux from the particles in the source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        skip_validation : bool</span>
<span class="sd">            SPH kernel interpolation onto the DataCube is approximated for</span>
<span class="sd">            increased speed. For some combinations of pixel size, distance</span>
<span class="sd">            and SPH smoothing length, the approximation may break down. The</span>
<span class="sd">            kernel class will check whether this will occur and raise a</span>
<span class="sd">            RuntimeError if so. This validation can be skipped (at the cost</span>
<span class="sd">            of accuracy!) by setting this parameter True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pixels indexed from 0 (not like in FITS!) for better use with numpy</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">skycoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sky_coordinates</span>
        <span class="n">particle_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span>
                <span class="n">skycoords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">skycoords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">skycoords</span><span class="o">.</span><span class="n">radial_velocity</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">origin</span><span class="p">))</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span>
        <span class="n">sm_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">hsm_g</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sky_coordinates</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">px_size</span> <span class="o">/</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_validation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sph_kernel</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">sm_length</span><span class="p">)</span>
        <span class="n">sm_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sm_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># pixel iteration</span>
        <span class="n">ij_pxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">product</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">logtag</span> <span class="o">+</span> <span class="s1">&#39;  [columns: </span><span class="si">{0:.0f}</span><span class="s1">, rows: </span><span class="si">{1:.0f}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">ij_px</span> <span class="ow">in</span> <span class="n">ij_pxs</span><span class="p">:</span>
            <span class="n">ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ij_px</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">logtag</span> <span class="o">+</span>
                      <span class="s1">&#39;  [row </span><span class="si">{:.0f}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ij</span> <span class="o">-</span> <span class="n">particle_coords</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">sm_range</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sph_kernel</span><span class="o">.</span><span class="n">px_weight</span><span class="p">(</span><span class="n">particle_coords</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">ij</span><span class="p">,</span>
                                                <span class="n">sm_length</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="p">[</span><span class="n">ij_px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ij_px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span>
                 <span class="n">weights</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">px_size</span> <span class="o">/</span> <span class="n">U</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Martini.write_fits"><a class="viewcode-back" href="../../martini.html#martini._martini.Martini.write_fits">[docs]</a>    <span class="k">def</span> <span class="nf">write_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output the DataCube to a FITS-format file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            Name of the file to write. &#39;.fits&#39; will be appended if not already</span>
<span class="sd">            present.</span>

<span class="sd">        channels : &#39;frequency&#39; (default), or &#39;velocity&#39;</span>
<span class="sd">            Type of units used along the spectral axis in output file.</span>

<span class="sd">        overwrite: bool</span>
<span class="sd">            Whether to allow overwriting existing files, note that the default</span>
<span class="sd">            is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">drop_pad</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">freq_channels</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;velocity&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Martini.write_fits: Unknown &#39;channels&#39; value &quot;</span>
                             <span class="s2">&quot;(use &#39;frequency&#39; or &#39;velocity&#39;.&quot;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.fits&#39;</span> <span class="k">else</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>

        <span class="n">wcs_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
        <span class="n">wcs_header</span><span class="o">.</span><span class="n">rename_keyword</span><span class="p">(</span><span class="s1">&#39;WCSAXES&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS&#39;</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;SIMPLE&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BITPIX&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">n_px_x</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">n_px_y</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">n_channels</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS4&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;EXTEND&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE4&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE4&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT4&#39;</span><span class="p">,</span> <span class="s1">&#39;PAR&#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;EPOCH&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="s1">&#39;MARTINI&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">))</span>
        <span class="c1"># header.append((&#39;BLANK&#39;, -32768)) #only for integer data</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BSCALE&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BZERO&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;DATAMAX&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;DATAMIN&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;ORIGIN&#39;</span><span class="p">,</span> <span class="s1">&#39;astropy v&#39;</span> <span class="o">+</span> <span class="n">astropy_version</span><span class="p">))</span>
        <span class="c1"># long names break fits format, don&#39;t let the user set this</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;MOCK&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BPA&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bpa</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;OBSERVER&#39;</span><span class="p">,</span> <span class="s1">&#39;K. Oman&#39;</span><span class="p">))</span>
        <span class="c1"># header.append((&#39;NITERS&#39;, ???))</span>
        <span class="c1"># header.append((&#39;RMS&#39;, ???))</span>
        <span class="c1"># header.append((&#39;LWIDTH&#39;, ???))</span>
        <span class="c1"># header.append((&#39;LSTEP&#39;, ???))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)))</span>
        <span class="c1"># header.append((&#39;PCDEC&#39;, ???))</span>
        <span class="c1"># header.append((&#39;LSTART&#39;, ???))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]))</span>
        <span class="c1"># header.append((&#39;LTYPE&#39;, ???))</span>
        <span class="c1"># header.append((&#39;PCRA&#39;, ???))</span>
        <span class="c1"># header.append((&#39;CELLSCAL&#39;, ???))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BMAJ&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmaj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BMIN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmin</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;Intensity&#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;SPECSYS&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;SPECSYS&#39;</span><span class="p">]))</span>

        <span class="c1"># flip axes to write</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">velocity_channels</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Martini.write_beam_fits"><a class="viewcode-back" href="../../martini.html#martini._martini.Martini.write_beam_fits">[docs]</a>    <span class="k">def</span> <span class="nf">write_beam_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output the beam to a FITS-format file.</span>

<span class="sd">        The beam is written to file, with pixel sizes, coordinate system, etc.</span>
<span class="sd">        similar to those used for the DataCube.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            Name of the file to write. &#39;.fits&#39; will be appended if not already</span>
<span class="sd">            present.</span>

<span class="sd">        channels : &#39;frequency&#39; (default), or &#39;velocity&#39;</span>
<span class="sd">            Type of units used along the spectral axis in output file.</span>

<span class="sd">        overwrite: bool</span>
<span class="sd">            Whether to allow overwriting existing files, note that the default</span>
<span class="sd">            is True.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If Martini was initialized without a beam.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Martini.write_beam_fits: Called with beam set &quot;</span>
                             <span class="s2">&quot;to &#39;None&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">freq_channels</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;velocity&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Martini.write_beam_fits: Unknown &#39;channels&#39; &quot;</span>
                             <span class="s2">&quot;value (use &#39;frequency&#39; or &#39;velocity&#39;.&quot;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.fits&#39;</span> <span class="k">else</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>

        <span class="n">wcs_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;SIMPLE&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BITPIX&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="c1"># header.append((&#39;NAXIS&#39;, self.beam.kernel.ndim))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;EXTEND&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BSCALE&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BZERO&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="c1"># this is 1/arcsec^2, is this right?</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;SPECSYS&#39;</span><span class="p">,</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;SPECSYS&#39;</span><span class="p">]))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BMAJ&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmaj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BMIN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmin</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BPA&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bpa</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;BTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;beam    &#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;EPOCH&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;OBSERVER&#39;</span><span class="p">,</span> <span class="s1">&#39;K. Oman&#39;</span><span class="p">))</span>
        <span class="c1"># long names break fits format</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;MOCKBEAM&#39;</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="s1">&#39;MARTINI&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;DATAMAX&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;DATAMIN&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;ORIGIN&#39;</span><span class="p">,</span> <span class="s1">&#39;astropy v&#39;</span> <span class="o">+</span> <span class="n">astropy_version</span><span class="p">))</span>

        <span class="c1"># flip axes to write</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">velocity_channels</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Martini.write_hdf5"><a class="viewcode-back" href="../../martini.html#martini._martini.Martini.write_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">write_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output the DataCube and Beam to a HDF5-format file. Requires the h5py</span>
<span class="sd">        package.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            Name of the file to write. &#39;.hdf5&#39; will be appended if not already</span>
<span class="sd">            present.</span>

<span class="sd">        channels : &#39;frequency&#39; (default), or &#39;velocity&#39;</span>
<span class="sd">            Type of units used along the spectral axis in output file.</span>

<span class="sd">        overwrite: bool</span>
<span class="sd">            Whether to allow overwriting existing files, note that the default</span>
<span class="sd">            is True.</span>

<span class="sd">        memmap: bool</span>
<span class="sd">            If True, create a file-like object in memory and return it instead</span>
<span class="sd">            of writing file to disk.</span>

<span class="sd">        compact: bool</span>
<span class="sd">            If True, omit pixel coordinate arrays to save disk space. In this</span>
<span class="sd">            case pixel coordinates can still be reconstructed from FITS-style</span>
<span class="sd">            keywords stored in the FluxCube attributes. Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">h5py</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">drop_pad</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">freq_channels</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;velocity&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Martini.write_fits: Unknown &#39;channels&#39; value &quot;</span>
                             <span class="s2">&quot;(use &#39;frequency&#39; or &#39;velocity&#39;.&quot;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.hdf5&#39;</span> <span class="k">else</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span>

        <span class="n">wcs_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">overwrite</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="s1">&#39;core&#39;</span> <span class="k">if</span> <span class="n">memmap</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">h5_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;backing_store&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span> <span class="k">if</span> <span class="n">memmap</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span> <span class="o">**</span><span class="n">h5_kwargs</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="s1">&#39;FluxCube&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;FluxCube&#39;</span><span class="p">]</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># index from 0 like numpy, not from 1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">compact</span><span class="p">:</span>
            <span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">vgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">cgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span>
                <span class="n">xgrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">ygrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">vgrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vgrid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">wgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">cgrid</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
            <span class="n">ragrid</span> <span class="o">=</span> <span class="n">wgrid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">decgrid</span> <span class="o">=</span> <span class="n">wgrid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">chgrid</span> <span class="o">=</span> <span class="n">wgrid</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ragrid</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decgrid</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">]</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;channel_mids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chgrid</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;channel_mids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;AxisOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(RA,Dec,Channels)&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FluxCubeUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;deltaRA_in_RAUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RA0_in_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RA0_in_RAUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RAUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RAProjType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;deltaDec_in_DecUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Dec0_in_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Dec0_in_DecUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DecUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DecProjType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;deltaV_in_VUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;V0_in_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;V0_in_VUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VProjType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BeamPA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bpa</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BeamMajor_in_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmaj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BeamMinor_in_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmin</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DateCreated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;MartiniVersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>
        <span class="n">c</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;AstropyVersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">astropy_version</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Beam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Beam&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BeamUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;deltaRA_in_RAUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RA0_in_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RA0_in_RAUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RAUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RAProjType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;deltaDec_in_DecUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Dec0_in_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Dec0_in_DecUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DecUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DecProjType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;deltaV_in_VUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;V0_in_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;V0_in_VUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VProjType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BeamPA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bpa</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BeamMajor_in_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmaj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;BeamMinor_in_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">bmin</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DateCreated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;MartiniVersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>
            <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;AstropyVersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">astropy_version</span>

        <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">velocity_channels</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">memmap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Kyle Oman

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>